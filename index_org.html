<!DOCTYPE html>
<html>

<head>

        <style>
                #menulinks li {
                        display: inline;
                }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script>
                var db;
                var dbrequest;
                var SelectedId;
                function onInitBody() {
                        if (dbrequest == undefined) {
                                dbrequest = indexedDB.open("MyDB", 1);
                                dbrequest.onsuccess = function (event) {
                                        console.log(" Opened DB.");
                                }
                                dbrequest.onerror = function (event) {
                                        console.log("DBrequest Failed.");
                                }

                                dbrequest.onupgradeneeded = function (event) {
                                        console.log("Running onupgradeneeded");

                                        db = event.target.result;
                                        if (!db.objectStoreNames.contains("Resources")) {
                                                var objectstore = db.createObjectStore("Resources");
                                        }
                                        if (!db.objectStoreNames.contains("LocalList")) {
                                                var LocalList = db.createObjectStore('LocalList', { keyPath: 'id' });
                                                LocalList.createIndex('Title', 'Title');
                                                LocalList.createIndex('Album', 'Album');
                                                LocalList.createIndex('Artist', 'Artist');
                                                LocalList.createIndex('Length', 'Length');
                                                LocalList.createIndex('Env', 'Env');
                                        }
                                        if (!db.objectStoreNames.contains("Thumbnails")) {
                                                var objectstore = db.createObjectStore("Thumbnails");
                                        }
                                }
                        }
                        return dbrequest;
                }
                function middleManMetaAndUList(id) {
                        var listbox = document.getElementById("metaimglist");
                        SelectedId = id;
                        showImage(0);
                }
                function showImage(operation) {

                        var listbox = document.getElementById("metaimglist");
                        var img = document.getElementById('base');
                        var i = listbox.selectedIndex;

                        console.log("Len = " + listbox.length);
                        console.log("Sel ind=" + i);
                        if (i == -1) {
                                operation = 1;
                        }
                        if (operation == 1) {
                                i = i + 1;
                                document.getElementById("play").value = "||";
                                listbox.selectedIndex = i;

                                if (i >= listbox.length) {
                                        return;
                                }
                        }
                        else if (operation == -1) {
                                i = i - 1;
                                document.getElementById("play").value = "||";
                                listbox.selectedIndex = i;

                                if (i < 0) {
                                        return;
                                }
                        }
                        else {
                                if (i < 0 || i > listbox.length) {
                                        return;
                                }
                                if (listbox.selectedOptions[0].value == SelectedId) {
                                        if (document.getElementById("play").value == "||") {
                                                document.getElementById("play").value = ">";
                                                //     img.pause();
                                        }
                                        else {
                                                document.getElementById("play").value = "||";
                                                //     img.play();
                                        }
                                        return;
                                }
                                else {
                                        document.getElementById("play").value = "||";
                                        listbox.value = SelectedId;
                                }
                        }
                        var a = listbox.selectedOptions[0].value;



                        dbrequest = onInitBody();
                        dbrequest.onsuccess = function (e) {
                                console.log(e);
                                console.log("Upgrade successful.");
                        }
                        if (dbrequest.readyState == "done") {
                                db = dbrequest.result;
                                var trans = db.transaction("Resources", "readonly");
                                trans.onsuccess = function (event) {
                                }

                                var request = trans.objectStore("Resources");
                                var objectStoreRequest = request.get(a);

                                objectStoreRequest.onsuccess = function (event) {
                                        var mycount = objectStoreRequest.result;
                                        if (mycount != undefined) {
                                                console.log(" Loading Asset from Local Db.");
                                                img.src = window.URL.createObjectURL(event.target.result);


                                                // if (playPromise !== undefined) {
                                                //         playPromise.then(_ => {
                                                //                 document.getElementById("playpause").innerHTML = "||";
                                                //         }).catch(error => {
                                                //                 document.getElementById("playpause").innerHTML = ">";
                                                //         });
                                                // }
                                        }
                                        else {
                                                console.log(" Loading Asset from Network.");
                                                var xhttp = new XMLHttpRequest();
                                                xhttp.onreadystatechange = function () {
                                                        if (this.readyState == 4 && this.status == 200) {
                                                                var resources = db.transaction("Resources", "readwrite").objectStore("Resources");
                                                                var b = new Blob(this.response, { type: "audio/mpeg" });
                                                                resources.add(b, a);
                                                                //document.getElementById("output").innerHTML = this.response;
                                                                var img = document.getElementById("base");
                                                                var url = window.URL;
                                                                console.log(url);
                                                                img.src = url.createObjectURL(this.response);
                                                                //  img.play();
                                                        }
                                                };
                                                xhttp.open("GET", "/assets/" + a, true);
                                                xhttp.responseType = "blob";
                                                xhttp.send();
                                        }
                                }
                        }
                        getinfo(a);

                }
                function changeBackground(url) {
                        $('#blur1').fadeTo('slow', 0, function () {
                                $(this).css('background-image', "url('" + url + "')");
                        }).delay(1000).stop(true, true).fadeTo('slow', 1);
                }
                function getImagePath(id, img) {
                        var dbrequest = onInitBody();
                        if (dbrequest.readyState == "done") {
                                db = dbrequest.result;
                                var trans = db.transaction("Thumbnails", "readonly");
                                trans.onsuccess = function (event) {
                                }

                                var request = trans.objectStore("Thumbnails");
                                var objectStoreRequest = request.get(id);

                                objectStoreRequest.onsuccess = function (event) {
                                        var mycount = objectStoreRequest.result;
                                        if (mycount != undefined) {
                                                console.log(" Loading Thumbs from Local Db.");
                                                //var b= new Blob([event.target.result],{type:"type/png"});
                                                var u = window.URL.createObjectURL(event.target.result);
                                                img.src = u;

                                        }
                                        else {
                                                console.log(" Loading Thumbs from Network.");
                                                var xhttp = new XMLHttpRequest();
                                                xhttp.onreadystatechange = function () {
                                                        if (this.readyState == 4 && this.status == 200) {
                                                                var resources = db.transaction("Thumbnails", "readwrite").objectStore("Thumbnails");
                                                                var b = new Blob([this.response], { type: "type/png" });
                                                                resources.add(b, id);
                                                                img.src = window.URL.createObjectURL(b);

                                                        }
                                                };
                                                xhttp.open("GET", "/assets/i" + id, true);
                                                xhttp.responseType = "blob";
                                                xhttp.send();
                                        }
                                }
                        }
                }

                function AddtoControlList(cursor) {
                        var imglist = document.getElementById('imglist');
                        var li = document.createElement("li");
                        var record = document.createElement("div");
                        var img = document.createElement("img");
                        img.style.width = "10px";
                        img.style.height = "10px";
                        getImagePath(cursor.id, img);
                        var title = document.createElement("a");
                        title.innerHTML = cursor.Title;
                        title.href = "javascript:middleManMetaAndUList(" + cursor.id + ")";
                        record.appendChild(img);
                        record.appendChild(title);
                        li.appendChild(record);
                        imglist.appendChild(li);
                }

                function AddtoControlMetaList(cursor) {
                        var imglist = document.getElementById('metaimglist');
                        var opt = document.createElement('option');
                        opt.value = cursor.id;
                        opt.innerHTML = cursor.Title;
                        imglist.appendChild(opt);
                        AddtoControlList(cursor);
                }

                function loadPlaylist(id) {
                        var dbrequest = onInitBody();
                        dbrequest.onsuccess = function (db) {
                                db = dbrequest.result;
                                var trans = db.transaction("LocalList", "readonly");
                                trans.onsuccess = function (event) {
                                }

                                var request = trans.objectStore("LocalList");
                                if (id == undefined || id == 0) {
                                        var objectStoreRequest = request.count();
                                        objectStoreRequest.onsuccess = function (event) {
                                                var mycount = objectStoreRequest.result;

                                                if (mycount > 0) {
                                                        console.log(" Loading List from Local Db.");
                                                        var trans1 = db.transaction("LocalList", "readonly");
                                                        trans1.onsuccess = function () {
                                                        }
                                                        var request1 = trans1.objectStore("LocalList");
                                                        var objectStoreRequest1 = request1.openCursor();
                                                        objectStoreRequest1.onsuccess = function (event1) {
                                                                var cursor = event1.target.result;
                                                                if (cursor) {
                                                                        var nc = new Cursor(cursor.value.id, cursor.value.Title);
                                                                        AddtoControlMetaList(nc);
                                                                        cursor.continue();
                                                                }
                                                        }
                                                }
                                                else {
                                                        console.log(" Loading List from Network.");
                                                        var xhttp = new XMLHttpRequest();
                                                        xhttp.onreadystatechange = function () {
                                                                if (this.readyState == 4 && this.status == 200) {
                                                                        var resources = db.transaction("LocalList", "readwrite").objectStore("LocalList");
                                                                        var imglist = document.getElementById('imglist');
                                                                        var itemData = JSON.parse(this.response);
                                                                        for (var i = 0; i < itemData.length; i++) {
                                                                                resources.add(itemData[i]);
                                                                                AddtoControlMetaList(itemData[i]);
                                                                        }
                                                                }
                                                        };
                                                        xhttp.open("GET", "\list.json", true);
                                                        xhttp.setRequestHeader("Content-Type", "application/json");
                                                        xhttp.send();
                                                }
                                        }
                                }

                        }
                        if (typeof id !== "undefined") {
                                var imglist = document.getElementById('metaimglist');
                                console.log(id);

                                var exists = false;
                                for (var i = 0; i < imglist.length; i++) {
                                        if (imglist[i].value == id) {
                                                exists = true;
                                                middleManMetaAndUList(i);
                                                break;
                                        }
                                }
                                if (!exists) {
                                        var cursor = new Cursor();
                                        cursor.id = id;
                                        cursor.Title = document.getElementById("ItemId" + id).children["ItemTitle"].innerHTML;
                                        cursor.Album = document.getElementById("ItemId" + id).children["ItemAlbum"].innerHTML;
                                        cursor.Artist = document.getElementById("ItemId" + id).children["ItemArtist"].innerHTML;
                                        cursor.Length = document.getElementById("ItemId" + id).children["ItemLength"].innerHTML;
                                        cursor.Env = document.getElementById("ItemId" + id).children["ItemEnv"].innerHTML;
                                        AddtoControlMetaList(cursor);
                                        saveListToLocal(cursor);
                                        middleManMetaAndUList(id);
                                }
                        }
                }

                function saveListToLocal(cursor) {
                        var dbrequest = onInitBody();
                        if (dbrequest.readyState == "done") {
                                db = dbrequest.result;
                                if (!(typeof cursor == undefined || cursor.id == 0)) {
                                        console.log(" Saving Rercord to Local Db.");
                                        var resources = db.transaction("LocalList", "readwrite").objectStore("LocalList");
                                        var newItem = [{ id: cursor.id, Title: cursor.Title, Album: cursor.Album, Length: cursor.Length, Env: cursor.Env, Artist: cursor.Artist }];
                                        resources.add(newItem[0]);
                                }
                        }
                }
                function Cursor(id, Title, Album, Artist, Length, Env) {
                        var classname = 'Cursor';
                        this.id = id;
                        this.Title = Title;
                        this.Album = Album;
                        this.Artist = Artist;
                        this.Length = Length;
                        this.Env = Env;
                        this.run = function () {
                                console.log(this.id + ' runs and runs!');
                        }
                        this.info = function () {
                                console.log(this.id + ' is a ' + this.Title + ' ' + classname);
                        }
                }
                function getinfo(id) {

                        var dbrequest = onInitBody();
                        var title = document.getElementById("title");
                        var info = document.getElementById("listORinfo");
                        info.innerHTML = "";
                        if (dbrequest.readyState == "done") {

                                db = dbrequest.result;
                                var trans1 = db.transaction("LocalList", "readonly");
                                trans1.onsuccess = function () {
                                }
                                var request1 = trans1.objectStore("LocalList");
                                var objectStoreRequest1 = request1.get(parseInt(id));
                                objectStoreRequest1.onsuccess = function (event1) {
                                        var cursor = objectStoreRequest1.result;
                                        if (cursor != undefined) {
                                                //info.innerHTML =relatedrecords();
                                                // var img = document.createElement("img");
                                                // img.style.width = "10px";
                                                // img.style.height = "10px";
                                                // getImagePath(cursor.id, img);
                                                // img.onload = function () { document.getElementById("thumbimg").src = img.src; changeBackground(img.src); };
                                                createMetaDiv(id, cursor.Title, "Artist: " + cursor.Artist, "Album: " + cursor.Album);
                                                info.insertAdjacentElement('afterbegin', img);
                                                title.innerHTML = cursor.Title + " Album:" + cursor.Album + " Artist:" + cursor.Artist;
                                        }
                                }
                        }

                }

                function linkfunction(link, id) {
                        console.log(" Loading " + link + " from Network.");
                        var xhttp = new XMLHttpRequest();
                        xhttp.onreadystatechange = function () {
                                if (this.readyState == 4 && this.status == 200) {
                                        var listORinfo = document.getElementById('listORinfo');
                                        listORinfo.innerHTML = "";
                                        var itemData = JSON.parse(this.response);

                                        var i = 0, t = 0;
                                        for (i = 0; i < itemData.length; i++) {
                                                createRecordDiv(new Cursor(itemData[i].id, itemData[i].Title, itemData[i].Album, itemData[i].Artist, itemData[i].Length, itemData[i].Env));
                                                t = t + parseInt(itemData[i].Length);
                                        }

                                        createMetaDiv(id, "Top Records", "Items: " + i, "Time: " + t + " Units");
                                }
                        };
                        xhttp.open("GET", '/' + link, true);
                        xhttp.setRequestHeader("Content-Type", "application/json");
                        xhttp.send();
                }

                function createMetaDiv(id, Title, TotolCount, TotalTime) {

                        document.getElementById("consoleMetaDataTitle").innerHTML = Title;
                        document.getElementById("consoleMetaDataCount").innerHTML = TotalTime;
                        document.getElementById("consoleMetaDataTime").innerHTML = TotolCount;
                        getImagePath(id, document.getElementById("consoleMetaImg"));
                }
                function createRecordDiv(cursor) {

                        var div = document.createElement("div")
                        div.id = "ItemId" + cursor.id;
                        //div.style.width = "100%";
                        div.style.height = "60px";
                        div.style.borderStyle = "solid";
                        div.style.borderWidth = "1px";
                        div.style.borderColor = "lightgrey";
                        div.style.padding = "10px";

                        var imgdiv = document.createElement("div")
                        imgdiv.style.padding = "5px";
                        imgdiv.style.cssFloat = "left";
                        var img = document.createElement("img");
                        getImagePath(cursor.id, img);
                        img.style.width = "45px";
                        img.style.height = "45px";
                        img.style.borderStyle = "solid";
                        img.style.borderWidth = "1px";
                        img.style.borderColor = "lightgrey";
                        imgdiv.appendChild(img);

                        div.appendChild(imgdiv);

                        var infodiv = document.createElement("div")
                        infodiv.style.padding = "5px";
                        infodiv.style.cssFloat = "left";
                        var anc = document.createElement("a");
                        anc.href = "javascript:loadPlaylist(" + cursor.id + ")";
                        anc.text = cursor.Title;
                        anc.id = "ItemTitle";
                        infodiv.appendChild(anc);
                        infodiv.appendChild(document.createElement("br"));

                        anc = document.createElement("a");
                        anc.href = "javascript:loadPlaylist(" + cursor.id + ")";
                        anc.text = cursor.Album;
                        anc.id = "ItemAlbum";
                        anc.style = "font-size:10px";
                        infodiv.appendChild(anc);
                        infodiv.appendChild(document.createTextNode(" "));

                        anc = document.createElement("a");
                        anc.href = "javascript:loadPlaylist(" + cursor.id + ")";
                        anc.text = cursor.Length;
                        anc.id = "ItemLength";
                        anc.style = "font-size:10px";
                        infodiv.appendChild(anc);
                        infodiv.appendChild(document.createTextNode(" "));

                        anc = document.createElement("a");
                        anc.href = "javascript:loadPlaylist(" + cursor.id + ")";
                        anc.text = cursor.Artist;
                        anc.id = "ItemArtist";
                        anc.style = "font-size:10px";
                        infodiv.appendChild(anc);
                        infodiv.appendChild(document.createTextNode(" "));

                        anc = document.createElement("a");
                        anc.href = "javascript:loadPlaylist(" + cursor.id + ")";
                        anc.text = cursor.Env;
                        anc.id = "ItemEnv";
                        anc.style = "font-size:10px";
                        infodiv.appendChild(anc);
                        div.appendChild(infodiv);
                        listORinfo.appendChild(div);
                }
        </script>
        <link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body id="wall" onload="loadPlaylist()">
        <DIV class="blur2">
                <div class="thumb-wall" id="blur1"></div>
        </DIV>
        <div>
                <table border="1" id="Header" class="top-bar">

                        <tr>
                                <td style="width:30%">
                                        <span id="Heading">WEBS</span>
                                </td>

                                <td style="width:30%">
                                        <input type="text" id="searchbox" class="top-searchbox" placeholder="Search">
                                </td>
                                <td>
                                        <ul id="menulinks" class="top-links">
                                                <li>
                                                        <a href="javascript:linkfunction('link1',100)">Link 1</a>
                                                </li>
                                                <li>Link 2</li>
                                                <li>Link 3</li>
                                                <li>Link 4</li>
                                        </ul>
                                </td>
                        </tr>
                </table>
        </div>

        <div class="user-list" style="overflow-y: scroll;">
                <ul id="imglist"></ul>
                <select id="metaimglist" size="20" onchange="showImage(0)" style="display: none"></select>
        </div>

        <div class="centerconsole">
                <div id="consoleMeta" class="console-Meta">
                        <div id="consoleMetaImgDiv" class="console-MetaImgDiv">
                                <img id="consoleMetaImg" class="console-MetaImg"/>
                        </div>
                        <div id="consoleMetaData" class="console-MetaData">
                                <div id="consoleMetaDataCount"></div>

                                <br>
                                <div id="consoleMetaDataTime"></div>

                                <br>
                        </div>
                </div>
                <div id="consoleMetaDataTitle" class="console-MetaDataTitle"></div>
                <div id="listORinfo" class="listORinfo-Div"></div>
        </div>

        <div id="player" class="player">
                <table border=1 class="player_container">
                        <tr>
                                <td colspan="4">
                                        progress bar
                                </td>
                        </tr>
                        <tr>
                                <td rowspan="3" style="width:30%">
                                </td>
                                <td rowspan="3" style="width:10%">
                                        <img id="thumbimg" style="width:10px;height:10px;float:right;">
                                </td>
                                <td>
                                        <p id="title">Select</p>
                                </td>
                                <td rowspan="3" style="width: 20%">
                                        <button id="volume" onclick="volume">V</button>
                                        <button id="repeat" onclick="repeat">R</button>
                                        <button id="shuffle" onclick="shuffle">S</button>
                                </td>
                        </tr>
                        <tr>
                                <td>
                                        <div id="controls" class="controls">
                                                <button id="prev" onclick="showImage(-1)">P</button>
                                                <input type="submit" id="play" onclick="showImage(0)" value=">" />
                                                <button id="next" onclick="showImage(1)">N</button>
                                        </div>
                                </td>
                        </tr>
                        <tr>
                                <td>
                                        <audio controls id="base" style="display:none">
                                                <source src="" type="audio/mp3"> Your browser does not support the audio tag.
                                        </audio>
                                </td>
                        </tr>
                </table>

        </div>
</body>

</html>
